From: L. David Baron <dbaron@dbaron.org>

Backout changesets 8f240265df77 and 1ead7ec99cea (bug 734569) to fix bug 810586.  approval-mozilla-beta=bajaj

diff --git a/layout/reftests/table-width/colspan-distribute-to-empty-1-ref.html b/layout/reftests/table-width/colspan-distribute-to-empty-1-ref.html
deleted file mode 100644
--- a/layout/reftests/table-width/colspan-distribute-to-empty-1-ref.html
+++ /dev/null
@@ -1,14 +0,0 @@
-<!DOCTYPE HTML>
-<title>Distributing widths from spanning cells to empty columns</title>
-<table cellpadding="0" cellspacing="0" width="75">
-  <tr>
-    <td width="25" bgcolor="yellow" >&nbsp;</td>
-    <td width="25" bgcolor="aqua"   >&nbsp;</td>
-    <td width="25" bgcolor="aqua"   >&nbsp;</td>
-  </tr>
-  <tr>
-    <td width="25" bgcolor="fuchsia">&nbsp;</td>
-    <td width="25" bgcolor="fuchsia">&nbsp;</td>
-    <td width="25" bgcolor="yellow" >&nbsp;</td>
-  </tr>
-</table>
diff --git a/layout/reftests/table-width/colspan-distribute-to-empty-1a.html b/layout/reftests/table-width/colspan-distribute-to-empty-1a.html
deleted file mode 100644
--- a/layout/reftests/table-width/colspan-distribute-to-empty-1a.html
+++ /dev/null
@@ -1,12 +0,0 @@
-<!DOCTYPE HTML>
-<title>Distributing widths from spanning cells to empty columns</title>
-<table cellpadding="0" cellspacing="0">
-  <tr>
-    <td width="25"             bgcolor="yellow" >&nbsp;</td>
-    <td width="50" colspan="2" bgcolor="aqua"   >&nbsp;</td>
-  </tr>
-  <tr>
-    <td width="50" colspan="2" bgcolor="fuchsia">&nbsp;</td>
-    <td width="25"             bgcolor="yellow" >&nbsp;</td>
-  </tr>
-</table>
diff --git a/layout/reftests/table-width/colspan-distribute-to-empty-1b.html b/layout/reftests/table-width/colspan-distribute-to-empty-1b.html
deleted file mode 100644
--- a/layout/reftests/table-width/colspan-distribute-to-empty-1b.html
+++ /dev/null
@@ -1,12 +0,0 @@
-<!DOCTYPE HTML>
-<title>Distributing widths from spanning cells to empty columns</title>
-<table cellpadding="0" cellspacing="0" width="75">
-  <tr>
-    <td width="25"             bgcolor="yellow" >&nbsp;</td>
-    <td width="50" colspan="2" bgcolor="aqua"   >&nbsp;</td>
-  </tr>
-  <tr>
-    <td width="50" colspan="2" bgcolor="fuchsia">&nbsp;</td>
-    <td width="25"             bgcolor="yellow" >&nbsp;</td>
-  </tr>
-</table>
diff --git a/layout/reftests/table-width/colspan-distribute-to-empty-2-ref.html b/layout/reftests/table-width/colspan-distribute-to-empty-2-ref.html
deleted file mode 100644
--- a/layout/reftests/table-width/colspan-distribute-to-empty-2-ref.html
+++ /dev/null
@@ -1,13 +0,0 @@
-<!DOCTYPE html>
-<table width="250" cellpadding="0" border="0" cellspacing="0">
-<tr>
-<td width="50" bgcolor=yellow>50
-<td width="180" bgcolor=aqua>This is a cell with enough text in it to wrap.
-<td width="20" bgcolor=lime><span style="display:inline-block"></span>
-</table>
-<table width="250" cellpadding="0" border="0" cellspacing="0">
-<tr>
-<td width="180" bgcolor=fuchsia>This is a cell with enough text in it to wrap.
-<td width="50" bgcolor=yellow>50
-<td width="20" bgcolor=lime><span style="display:inline-block"></span>
-</table>
diff --git a/layout/reftests/table-width/colspan-distribute-to-empty-2.html b/layout/reftests/table-width/colspan-distribute-to-empty-2.html
deleted file mode 100644
--- a/layout/reftests/table-width/colspan-distribute-to-empty-2.html
+++ /dev/null
@@ -1,11 +0,0 @@
-<!DOCTYPE html>
-<table width="250" cellpadding="0" border="0" cellspacing="0">
-<tr>
-<td width="50" bgcolor=yellow>50
-<td colspan="2" bgcolor=aqua>This is a cell with enough text in it to wrap.
-<td bgcolor=lime><span style="display:inline-block; width: 20px"></span>
-<tr>
-<td colspan="2" bgcolor=fuchsia>This is a cell with enough text in it to wrap.
-<td width="50" bgcolor=yellow>50
-<td bgcolor=lime><span style="display:inline-block; width: 20px"></span>
-</table>
diff --git a/layout/reftests/table-width/reftest.list b/layout/reftests/table-width/reftest.list
--- a/layout/reftests/table-width/reftest.list
+++ b/layout/reftests/table-width/reftest.list
@@ -55,11 +55,8 @@ fails == default-box-sizing-collapse-qui
 == spanning-cell-sort-2-small-fixed.html spanning-cell-sort-2-fixed-ref.html
 == spanning-cell-sort-2-large-fixed.html spanning-cell-sort-2-fixed-ref.html
 == colgroup-vs-column-1.html colgroup-vs-column-1-ref.html
 == colgroup-vs-column-2.html colgroup-vs-column-2-ref.html
 == colgroup-vs-column-3.html colgroup-vs-column-3-ref.html
 == colgroup-vs-column-4.html colgroup-vs-column-4-ref.html
 == dynamic-fixed-layout-1.html dynamic-fixed-layout-1-ref.html
 == cell-pref-width-border-box.html cell-pref-width-border-box-ref.html
-== colspan-distribute-to-empty-1a.html colspan-distribute-to-empty-1-ref.html
-== colspan-distribute-to-empty-1b.html colspan-distribute-to-empty-1-ref.html
-== colspan-distribute-to-empty-2.html colspan-distribute-to-empty-2-ref.html
diff --git a/layout/tables/BasicTableLayoutStrategy.cpp b/layout/tables/BasicTableLayoutStrategy.cpp
--- a/layout/tables/BasicTableLayoutStrategy.cpp
+++ b/layout/tables/BasicTableLayoutStrategy.cpp
@@ -695,20 +695,20 @@ BasicTableLayoutStrategy::DistributeWidt
      *
      * If |aWidth| is *larger* than what we would assign in (4), then we
      * expand the columns:
      *
      *   a. if any columns without a specified coordinate width or
      *   percent width have nonzero pref width, in proportion to pref
      *   width [total_flex_pref]
      *
-     *   b. otherwise, if any columns without a specified coordinate
-     *   width or percent width, but with cells originating in them,
-     *   have zero pref width, equally between these
-     *   [numNonSpecZeroWidthCols]
+     *   b. (NOTE: this case is for BTLS_FINAL_WIDTH only) otherwise, if
+     *   any columns without a specified coordinate width or percent
+     *   width, but with cells originating in them have zero pref width,
+     *   equally between these [numNonSpecZeroWidthCols]
      *
      *   c. otherwise, if any columns without percent width have nonzero
      *   pref width, in proportion to pref width [total_fixed_pref]
      *
      *   d. otherwise, if any columns have nonzero percentage widths, in
      *   proportion to the percentage widths [total_pct]
      *
      *   e. otherwise, equally.
@@ -756,17 +756,18 @@ BasicTableLayoutStrategy::DistributeWidt
                 // we'll add on the rest of guess_min_spec outside the
                 // loop
                 nscoord delta = NSCoordSaturatingSubtract(pref_width, 
                                                           min_width, 0);
                 guess_min_spec = NSCoordSaturatingAdd(guess_min_spec, delta);
                 total_fixed_pref = NSCoordSaturatingAdd(total_fixed_pref, 
                                                         pref_width);
             } else if (pref_width == 0) {
-                if (cellMap->GetNumCellsOriginatingInCol(col) > 0) {
+                if (aWidthType == BTLS_FINAL_WIDTH &&
+                    cellMap->GetNumCellsOriginatingInCol(col) > 0) {
                     ++numNonSpecZeroWidthCols;
                 }
             } else {
                 total_flex_pref = NSCoordSaturatingAdd(total_flex_pref,
                                                        pref_width);
             }
         }
     }
@@ -817,16 +818,19 @@ BasicTableLayoutStrategy::DistributeWidt
                                                 nscoord_MAX);
         }
     } else {
         space = NSCoordSaturatingSubtract(aWidth, guess_pref, nscoord_MAX);
         if (total_flex_pref > 0) {
             l2t = FLEX_FLEX_LARGE;
             basis.c = total_flex_pref;
         } else if (numNonSpecZeroWidthCols > 0) {
+            NS_ASSERTION(aWidthType == BTLS_FINAL_WIDTH,
+                         "numNonSpecZeroWidthCols should only "
+                         "be set when we're setting final width.");
             l2t = FLEX_FLEX_LARGE_ZERO;
             basis.c = numNonSpecZeroWidthCols;
         } else if (total_fixed_pref > 0) {
             l2t = FLEX_FIXED_LARGE;
             basis.c = total_fixed_pref;
         } else if (total_pct > 0.0f) {
             l2t = FLEX_PCT_LARGE;
             basis.f = total_pct;
@@ -946,16 +950,19 @@ BasicTableLayoutStrategy::DistributeWidt
                             float c = float(space) / float(basis.c);
                             basis.c -= col_width;
                             col_width += NSToCoordRound(float(col_width) * c);
                         }
                     }
                 }
                 break;
             case FLEX_FLEX_LARGE_ZERO:
+                NS_ASSERTION(aWidthType == BTLS_FINAL_WIDTH,
+                             "FLEX_FLEX_LARGE_ZERO only should be hit "
+                             "when we're setting final width.");
                 if (pct == 0.0f &&
                     !colFrame->GetHasSpecifiedCoord() &&
                     cellMap->GetNumCellsOriginatingInCol(col) > 0) {
 
                     NS_ASSERTION(col_width == 0 &&
                                  colFrame->GetPrefCoord() == 0,
                                  "Since we're in FLEX_FLEX_LARGE_ZERO case, "
                                  "all auto-width cols should have zero pref "
